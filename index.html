<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 1</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
var vel = 500;
var interval = 300;
var gravity = 4000;
var jumpPower = 1500;

function preload() {

	game.load.image('sky', 'assets/sky.png');
	game.load.image('cloud', 'assets/cloud.png');
	game.load.image('ground', 'assets/platform.png');
	game.load.image('ground_red', 'assets/platform_red.png');
	game.load.image('ledge', 'assets/platform_r.png');
	game.load.image('spike', 'assets/spike.png');
	game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
	game.load.image('monster', 'assets/diamond.png');
	game.load.image('bullet', 'assets/star.png');

}

var platforms;
var deadly;
var projectiles;
var ground = [];
var clouds = [];
var spikes = [];
var ledges = [];
var bullets = [];
var monsters = [];
var ledgesOn = true;
var spikesOn = false;
var redGround = false;

function create() {

	game.world.setBounds(0, -100, 800, 700);

	game.physics.startSystem(Phaser.Physics.ARCADE);

	var sky = game.add.sprite(0, 0, 'sky');
	sky.fixedToCamera = true;

	landscape = game.add.group();
	landscape.enableBody = true;
	clouds[0] = landscape.create(100, 100, 'cloud');


	platforms = game.add.group();
	platforms.enableBody = true;
	last_ground_x = 0;
	for (i=0; i<3;i++) {
		groundPiece = platforms.create(-100 + last_ground_x, game.world.height - 164, 'ground');
		groundPiece.scale.setTo(1, 2);
		groundPiece.body.immovable = true;
		groundPiece.body.friction.x = 0;
		last_ground_x += game.world.width/2;
		ground.push(groundPiece);
	}

	deadly = game.add.group();
	deadly.enableBody = true;

	projectiles = game.add.group();
	projectiles.enableBody = true;

	player = game.add.sprite(100, game.world.height - 300, 'dude');
	player.scale.setTo(1.5, 1.5);
	game.physics.enable(player);
	player.body.collideWorldBounds = true;
	player.body.gravity.y = gravity;
	player.animations.add('left', [0, 1, 2, 3], 10, true);
	player.animations.add('right', [5, 6, 7, 8], 10, true);

	cursors = game.input.keyboard.createCursorKeys();
	spaceKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

	keyK = game.input.keyboard.addKey(Phaser.Keyboard.K);
    keyK.onDown.add(switchOnLedges, this);
    keyD = game.input.keyboard.addKey(Phaser.Keyboard.D);
    keyD.onDown.add(shootBullet, this);

}

function update() {

	ground.forEach(function(groundPiece) {
		groundPiece.body.velocity.x = -vel;
	})

	spikes.forEach(function(spike) {
		spike.body.velocity.x = -vel;
	})

	clouds.forEach(function(cloud) {
		cloud.body.velocity.x = -vel/100;
	})

	ledges.forEach(function(ledge) {
		ledge.body.velocity.x = -vel;
	})

	// Update monsters:
	monsters.forEach(function(monster_arr) {
		monster_arr[0].body.position.x = monster_arr[1].body.position.x;
	})

	//update bullets
	bullets.forEach(function(bullet) {
		bullet.body.velocity.x = vel * 2;
	})

	hitPlatform = game.physics.arcade.collide(player, platforms);
	hitSpike = game.physics.arcade.collide(player, deadly);

	function new_ground_piece() {
		if (!redGround) {
			groundPiece = platforms.create(game.world.width, game.world.height - 164, 'ground');
		} else {
			groundPiece = platforms.create(game.world.width, game.world.height - 164, 'ground_red');
		}
		groundPiece.scale.setTo(1, 2);
		groundPiece.body.immovable = true;
		groundPiece.body.friction.x = 0;
		ground.push(groundPiece);

	}

	function new_spikes() {
		spikes = []
		numberOfSpikes = Math.ceil(Math.random() * 3);
		last_spike_x = 0;
		for (i=0; i<numberOfSpikes; i++) {
			spike = deadly.create(game.world.width + last_spike_x, game.world.height - 164 - 64, 'spike');
			last_spike_x += 64;
			spike.scale.setTo(1, 1);
			spike.body.immovable = true;
			spike.body.friction.x = 0;
			spikes.push(spike);
			//create a monster:
			new_monster = deadly.create(spike.body.position.x, spike.body.position.y - 50, 'monster');
			new_monster.scale.setTo(2, 2);
			new_monster.body.position.x = spike.body.position.x + (spike.body.width/2) - (new_monster.body.width/2);
			new_monster.body.immovable = true;
			monsters.push([new_monster, spike]);
		}
		return spikes
	}

	function new_ledge(previous_ledge) {
		function next_y(height) {
			new_height = -1;
			while (!(new_height > 200 &&
				new_height < 400)) {
				new_height = height - 150 + Math.floor(Math.random() * 300);
			}
			return new_height;
		}
		ledge = platforms.create(game.world.width,
			next_y(previous_ledge.body.position.y),
			'ledge');
		ledge.scale.setTo(0.5, 0.5)
		ledge.body.immovable = true;
		ledge.body.friction.x = 0;
		return ledge;
	}

	last_ledge = ledges[ledges.length - 1]

	if (ledgesOn &&
		ledges.length == 0) {
		ledges.push(platforms.create(game.world.width,
			400,
			'ledge'));
		ledges[0].scale.setTo(0.5, 0.5)
		ledges[0].body.immovable = true;
		ledges[0].body.friction.x = 0;
	}else if (ledgesOn &&
		last_ledge.body.position.x < game.world.width - last_ledge.body.width - interval) {
		ledges.push(new_ledge(last_ledge));
	}

	if (ledges.length > 0 &&
		ledges[0].body.position.x < -ledges[0].body.width) {
		ledges[0].kill()
		ledges.shift();
	}

	last_spike = spikes[spikes.length - 1];

	if (spikesOn &&
		spikes.length == 0) {
		spikes.push(platforms.create(game.world.width,
			game.world.height - 164 - 64,
			'spike'));
		spikes[0].scale.setTo(1, 1)
		spikes[0].body.immovable = true;
		spikes[0].body.friction.x = 0;
	} else if (spikesOn &&
		last_spike.body.position.x < game.world.width/2) {
		new_spikes_arr = new_spikes();
		new_spikes_arr.forEach(function(spike) {
			spikes.push(spike);
		})
	}

	if (spikes.length > 0 &&
		spikes[0].body.position.x < -spikes[0].body.width) {
		spikes[0].kill();
		spikes.shift();
	}

	last_ground_piece = ground[ground.length -1];

	if (last_ground_piece.body.position.x < game.world.width - last_ground_piece.body.width + 10) {
		new_ground_piece();
	}

	if (ground[0].body.position.x < -ground[0].body.width) {
		ground[0].kill();
		ground.shift();
	}

	// Delete bullets:
	if (bullets.length > 0 &&
		bullets[0].body.position.x > game.world.width) {
		bullets[0].kill();
		bullets.shift();
	}

	if (spaceKey.isDown && player.body.touching.down) {
		player.body.velocity.y = -jumpPower;
		player.body.velocity.y -= 100;
	} else if (player.body.velocity.y < 0 && spaceKey.isUp) {
		player.body.velocity.y += 100;
	}

	player.body.velocity.x = 0;

	if (cursors.right.isDown) {
		player.body.velocity.x = 100;
	} else if (cursors.left.isDown) {
		player.body.velocity.x = -500;
	} else if (player.body.touching.down && hitPlatform) {
		velY = player.body.velocity.y;
		game.physics.arcade.moveToXY(player, 200, player.body.position.y, 100);
		player.body.velocity.y =velY;
	} else if (!player.body.touching.down && !hitPlatform) {
		player.frame = 6;
	}

	if (player.body.position.y < 100) {
		game.camera.y = player.body.position.y - 100;
	} else {
		game.camera.y = 0;
	}

	player.animations.play('right');

	if (game.input.activePointer.withinGame)
    {
        game.input.enabled = true;
    }
    else
    {
        game.input.enabled = false;
    }

}

function switchOnLedges() {
	ledgesOn = !ledgesOn;
	spikesOn = !spikesOn;
	redGround = !redGround;
}

function shootBullet() {
	bullet = projectiles.create(player.body.position.x + player.body.width, player.body.position.y + (player.body.height/2), 'bullet');
	bullet.body.immovable = true;
	bullets.push(bullet)
}
</script>

</body>
</html>